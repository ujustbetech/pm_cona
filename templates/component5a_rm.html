{% extends "base.html" %}
{% block content %}
<style>
/* Default: text left */
.table-wrapper th,
.table-wrapper td {
    text-align: left;
    white-space: nowrap;
}

/* Right-align numeric columns */
.table-wrapper td[data-col="Days_To_Receive"] {
    text-align: right;
    font-variant-numeric: tabular-nums;
}
</style>


<h2 style="color: white;">KPI Name: {{ label }} (SLA: 90 Days) - Data Period :Apr-Nov'25)</h2>
<h3 style="color: white;">Business Objective Alignment: Link Production / Manufacturing data to Sales (end to end visibility)</h3>
<!-- <h4>RM Requisitions – Quarterly SLA</h4> -->

<!-- <hr>


<div class="kpi-container">
  {% for key, value in summary.items() %}
    <div class="kpi-card">
      <div class="kpi-value">{{ value }}</div>
      <div class="kpi-label">
        {{ key.replace('_',' ').title() }}
      </div>
    </div>
  {% endfor %}
</div>

<hr> -->

<!-- CHART -->
{% if charts and charts.chart_0 %}
  <div class="chart-card">
    <h3>Quarterly SLA Performance</h3>
    {{ charts.chart_0 | safe }}
<script>
(function () {

  function attachHoverFix() {
    const plotDiv = document.querySelector(".chart-card .js-plotly-plot");
    if (!plotDiv || !window.Plotly) return;

    plotDiv.on('plotly_afterplot', function () {

      if (!plotDiv.data || !plotDiv.data.length) return;

      // Calculate total from ALL traces (safe)
      let total = 0;
      plotDiv.data.forEach(t => {
        if (t.values) {
          total += t.values.reduce((a, b) => a + b, 0);
        }
      });

      // Apply hovertemplate to ALL traces
      plotDiv.data.forEach((trace, i) => {
        Plotly.restyle(
          plotDiv,
          {
            hovertemplate:
              "%{label}<br>%{value} of " + total + " POs<br>%{percent}<extra></extra>",
            hoverinfo: "none"
          },
          [i]
        );
      });

    });
  }

  // Try repeatedly until Plotly attaches
  const interval = setInterval(() => {
    const plotDiv = document.querySelector(".chart-card .js-plotly-plot");
    if (plotDiv && window.Plotly) {
      clearInterval(interval);
      attachHoverFix();
    }
  }, 100);

})();
</script>



  </div>
{% endif %}
<h2 style="color:white;">Observation: Out of the total 5148 POs for all the departments, 781 POs were identified for 251 Marketing Vendors. After reviewing these POs, 376 were completed(excluded 405 POs were not complete). Upon checking these 376 POs for proper receipt dates, 297 POs were identified(excluded 79 POs proper receipt dates). Of these 297 POs, 216 POs (74.1%) were delayed and 77 POs (25.9%) were on time.</h2>
<div style="
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
">

    <h2 style="color:white; margin: 0;">KPI data in Table</h2>

    <div>
        <a href="javascript:history.back()"  
           style="
               background:#ffffff;
               color:#003d99;
               padding:8px 16px;
               border-radius:8px;
               font-weight:600;
               text-decoration:none;
               margin-right:10px;
               box-shadow:0 2px 5px rgba(0,0,0,0.15);
           ">
           ← Back
        </a>

        <a href="/download/{{ kpi_id }}" 
           style="
               background:#ffffff;
               color:#003d99;
               padding:8px 16px;
               border-radius:8px;
               font-weight:600;
               text-decoration:none;
               box-shadow:0 2px 5px rgba(0,0,0,0.15);
           ">
            ⬇ Download Excel
        </a>
    </div>

</div>

<hr>   

<!-- TABLE -->
{% if table_html %}
  <div class="table-wrapper">
            {{ table_html | safe | replace('PO_No', 'PO No') | replace('Order_Date', 'Order Date') | replace('Last_Receipt_Date', 'Last Receipt Date') | replace('Days_To_Receive', 'Days To Receive') | replace('Order_Quarter', 'Order Quarter') | replace('On_Time', 'Late/On Time') }}
  </div>
{% endif %}

<a href="/departments">← Back</a>

{% endblock %}
